---
// Overlay de carga branded que aparece mientras Calendly inicializa su popup
---

<!-- Overlay -->
<div
  id="calendly-loader"
  aria-hidden="true"
  style="
    position: fixed;
    inset: 0;
    z-index: 9998;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1.25rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    -webkit-backdrop-filter: blur(16px);
    backdrop-filter: blur(16px);
    background-color: rgba(249, 245, 240, 0.92);
  "
>
  <!-- Dark mode overlay tint -->
  <div
    id="calendly-loader-dark"
    style="
      position: absolute;
      inset: 0;
      background-color: rgba(26, 18, 21, 0.92);
      opacity: 0;
      transition: opacity 0.2s;
    "
  ></div>

  <!-- Content -->
  <div style="position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 1rem;">
    <!-- Spinning spa icon -->
    <div id="calendly-loader-icon" style="
      width: 5rem;
      height: 5rem;
      border-radius: 50%;
      background-color: rgba(226, 151, 156, 0.12);
      border: 1.5px solid rgba(226, 151, 156, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: loader-spin 3s ease-in-out infinite;
    ">
      <span
        class="material-symbols-outlined"
        style="font-size: 2.25rem; color: #E2979C; font-variation-settings: 'FILL' 0, 'wght' 300;"
      >spa</span>
    </div>

    <!-- Dots loader -->
    <div style="display: flex; gap: 0.4rem; align-items: center;">
      <span class="loader-dot" style="width: 6px; height: 6px; border-radius: 50%; background-color: #E2979C; animation: loader-dot-bounce 1.2s ease-in-out infinite; animation-delay: 0ms;"></span>
      <span class="loader-dot" style="width: 6px; height: 6px; border-radius: 50%; background-color: #E2979C; animation: loader-dot-bounce 1.2s ease-in-out infinite; animation-delay: 180ms;"></span>
      <span class="loader-dot" style="width: 6px; height: 6px; border-radius: 50%; background-color: #E2979C; animation: loader-dot-bounce 1.2s ease-in-out infinite; animation-delay: 360ms;"></span>
    </div>

    <!-- Text -->
    <p style="
      font-family: 'Playfair Display', Georgia, serif;
      font-style: italic;
      font-size: 1rem;
      color: #8E5E61;
      letter-spacing: 0.01em;
    ">Preparando tu agenda…</p>
  </div>
</div>

<style>
  @keyframes loader-spin {
    0%, 100% { transform: rotate(0deg) scale(1); }
    25%       { transform: rotate(15deg) scale(1.05); }
    75%       { transform: rotate(-15deg) scale(1.05); }
  }

  @keyframes loader-dot-bounce {
    0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
    40%           { transform: translateY(-6px); opacity: 1; }
  }

  @media (prefers-reduced-motion: reduce) {
    #calendly-loader-icon { animation: none !important; }
    .loader-dot { animation: none !important; opacity: 0.6; }
  }
</style>

<script>
  const loader = document.getElementById('calendly-loader') as HTMLDivElement;
  const loaderDark = document.getElementById('calendly-loader-dark') as HTMLDivElement;

  function showLoader() {
    // Sync dark mode tint
    const isDark = document.documentElement.classList.contains('dark');
    loaderDark.style.opacity = isDark ? '1' : '0';

    loader.style.opacity = '1';
    loader.style.pointerEvents = 'auto';
    loader.setAttribute('aria-hidden', 'false');
  }

  function hideLoader() {
    loader.style.opacity = '0';
    loader.style.pointerEvents = 'none';
    loader.setAttribute('aria-hidden', 'true');
  }

  // Escuchar evento personalizado emitido por los botones
  window.addEventListener('calendly:open', () => {
    showLoader();
  });

  // Escuchar mensajes de Calendly para saber cuándo cargó
  window.addEventListener('message', (e) => {
    if (e.origin !== 'https://calendly.com') return;
    try {
      const data = typeof e.data === 'string' ? JSON.parse(e.data) : e.data;
      const event = data?.event;
      // El popup ya renderizó contenido
      if (
        event === 'calendly.profile_page_viewed' ||
        event === 'calendly.event_type_viewed' ||
        event === 'calendly.date_and_time_selected'
      ) {
        hideLoader();
      }
      // El popup fue cerrado
      if (event === 'calendly.popup_closed') {
        hideLoader();
      }
    } catch {}
  });

  // Fallback: si pasan 8s sin respuesta de Calendly, ocultar de todas formas
  let loaderTimeout: ReturnType<typeof setTimeout>;
  window.addEventListener('calendly:open', () => {
    clearTimeout(loaderTimeout);
    loaderTimeout = setTimeout(hideLoader, 8000);
  });
</script>
